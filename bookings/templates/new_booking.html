{% extends 'base.html' %}



{% block script %}
         <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>

         <script type="text/javascript" >
            function GetDays(){
                    var dropdt = new Date(document.getElementById("cod").value);
                    var pickdt = new Date(document.getElementById("cid").value);
                    return parseInt((dropdt - pickdt) / (24 * 3600 * 1000));
            }

            function cal(){
                if(document.getElementById("cod")){
                    document.getElementById("total_days").value=GetDays();
                }
            }

         </script>
{% endblock script %}

{% block content %}
        <div class="row" style="padding-left: 2%;padding-top:1%;">
            <div class="col-md-9">
                <h2>BookMyHotel</h2>
            </div>
            {% if name %}
                <div class="col-md-3">
                    <a href="{% url 'dashboard' %}" >{{ name }}</a> |
                    <a href="{% url 'logout' %}" class="btn btn-primary" >Log out</a><br/><br/><br/>
                </div>
            {% endif %}

        </div>
        <form name="booking_form" id="booking_form" action="{% url 'booking' %}"  method="post">
            {% csrf_token %}
            <label id="head"><b>Booking Details</b></label><br><br/>
            <label id = "username_label">Username</label>: <label id="user_name" >{{ name }}</label><br/><br/>
            <label id = "Gid_label">Hotel ID</label>:
            <input type="text" name="hotel_id" id="hotel_id" value="{{ hotel_id }}" readonly><br/><br/>
            <label id = "Gid_label">Hotel name</label>: <label id="G_id">{{ hotel_name }}</label><br/><br/>
            <label class="form">Check In</label>:
            <input type="date" class="textbox" id="cid" name="check_in_date" placeholder="YYYY/MM/DD" size="10" required/>
            <input type="time" id="cit" name="check_in_time" placeholder="HH:MM" size="5" required>
            <select name="session1">
                <option value="AM">AM</option>
                <option value="PM">PM</option>
            </select><br><br>
            <label class="form">Checkout</label>:
            <input type="date" class="textbox" id="cod" name="check_out_date" onchange="cal()" placeholder="YYYY/MM/DD" size="10" required/>
            <input type="time" id="cot" name="check_out_time" placeholder="HH:MM" size="5" required>
            <select name="session2">
                <option value="AM">AM</option>
                <option value="PM">PM</option>
            </select>
            <br><br>
            <label class="form">Number of days</label>:
            <input type="text" class="textbox" id="total_days" name="total_days" readonly="true" size="5" required><br><br>
            <label id = "total_guests">Number of Guests</label>:
            <select name="total_guests">
                <option value="1"> 1 </option>
                <option value="2"> 2</option>
                <option value="3"> 3</option>
                <option value="4"> 4</option>
                <option value="5"> 5</option>
                <option value="6"> 6</option>
                <option value="7"> 7</option>
                <option value="8"> 8</option>
                <option value="9"> 9</option>
                <option value="10"> 10</option>
            </select><br><br>
            <label id = "rooms">Room Type</label>:
            <select id="room_type" name="room_type" onchange="get()" required>
                <option value="none">Select Room Type</option>
                    {% for item in room_types %}
                        <option  value="{{ item }}">{{ item }}</option>
                     {% endfor %}
            </select><br><br>
            <label >Price per day</label>
            <label id="price_per_day"></label><br/><br/>
            <label id = "status_label">Room Status</label>
            <label id="status" ></label><br/><br/>
            <label id = "rooms">Rooms needed</label>:
            <input id="total_rooms" name="total_rooms" size="5" type="text" required><br/><br/>
            <label id="discount_id" >Check for discount</label>
            <input type="hidden" name="discount_id" id="discount_id"><br><br/>
            <label id = "discount"></label>
            <button type="button" id="dis_btn" class="btn1">Check</button><br/><br/>
            <label id = "total">Total Cost</label>:
            <b >Rs.</b><input type="text" class="textbox" id="total_cost" size="10" name="total_cost" value="0" readonly>
            <label id = "discount_label">Discounted Cost</label>:
            <b >Rs.</b><input type="text" class="textbox" id="discounted_price" size="10" name="discounted_price" value="0" readonly>
            <button type="button" id="apply" disabled="true" class="btn1">Apply</button> <br/>
            <input type="submit"  value="Submit" class="btn" id="submit"><br><br>

        </form>
        <script>
            var available;
            var price;
            var discount_status = null;
            $(document).ready(function() {
                $('#dis_btn').prop('disabled', false);
                $('#room_type').on('change', function () {
                    var total_rooms = $('#total_rooms').val();
                    var total_days = $('#total_days').val();
                    var data = {"room_type": $(this).val(), "request_no": 1};
                    $.ajax({
                        url: {% url 'booking' %},
                        contentType:"application/json",
                        dataType:"json",
                        data: data,
                        success: function (data) {
                            price = parseInt(data.room_price);
                            $('#price_per_day').text("Rs. "+data.room_price);
                            available = parseInt(data.rooms_available);
                            $('#status').text(data.rooms_available + " Rooms available on selected category");
                            if(total_rooms!=null && price !=null && total_days!=null){
                                if(parseInt(total_rooms) == available){
                                    $('#total_cost').val(parseFloat(parseInt(total_rooms)*price*parseInt(total_days)).toFixed(2));
                                }
                                else if(parseInt(total_rooms)>available){
                                    $('#total_rooms').val('');
                                    alert('More than available entered')
                                    $('#total_cost').val("Rs. ");
                                }

                            }
                        },
                        error: function (msg) {
                            alert(msg);
                            $('#price_per_day').text('');
                            $('#status').text('');
                        }
                    });


                });
                $('#submit').on('click', function () {
                    if (discount_status != null) {
                        $('#discount_id').val(discount_status);

                    }
                });

               $('#dis_btn').on('click',function () {
                     var total_days = $('#total_days').val();
                     var total_rooms = $('#total_rooms').val();
                     var room1 = $('#room_type').val()
                     if(total_days != null && room1 != 'Select Room Type' && total_rooms != null ){
                         var data = {"request_no": 2, "no_of_days": total_days};
                          $.ajax({
                            url: {% url 'booking' %},
                            contentType:"application/json",
                            dataType:"json",
                            data: data,
                            success: function (data) {
                                var message = data.message;

                                if(message == 'success'){

                                    var total = parseInt($('#total_rooms').val())*price*parseInt(total_days);
                                    $('#dis_btn').prop('disabled', true);
                                    var discount_id = data.discount_id;
                                    var offer = data.offer_percent;
                                    $('#discount').text(discount_id+" is available.");

                                    $('#apply').prop('disabled', false);
                                    $('#apply').on('click', function () {
                                        discount_status = discount_id;
                                        $('#discounted_price').val(parseFloat(total-(total*(parseInt(offer)/100))).toFixed(2))
                                        $('#apply').prop('disabled', true);
                                    });
                                }
                                else{
                                    $('#discount').text(data.discount_id);
                                }


                            },
                            error: function (msg) {
                                alert(msg);

                            }
                          });
                     }
                     else {
                         alert("Please fill all the fields")
                     }
               });

                $('#total_rooms').on('change',function () {
                    var total_rooms = parseInt($('#total_rooms').val());
                    if(total_rooms == available){
                        if(total_rooms != null && price !=  null&& $('#total_days').val()!=null) {
                            $('#total_cost').val(parseFloat(parseInt(total_rooms) * price * parseInt($('#total_days').val())).toFixed(2));
                        }
                    }
                    else if(total_rooms>available){
                                $('#total_rooms').val('');
                                alert('More than available entered')
                                $('#total_cost').val(0);
                    }
                });
            });
        </script>
 {% endblock content %}